<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Jhim-montage-video</title>
<style>
body {margin:0;font-family:sans-serif;background:#0e0f14;color:#fff;display:flex;flex-direction:column;height:100vh}
header {background:#141622;padding:12px;text-align:center;font-weight:bold;font-size:18px}
.viewer {flex:1;display:flex;align-items:center;justify-content:center;margin:8px;border-radius:12px;background:#10121b;position:relative}
video, canvas {max-width:100%;max-height:100%;border-radius:12px;background:black}
.controls {padding:10px;background:#1a1d2b;display:flex;flex-direction:column;gap:8px}
.toolbar {display:flex;justify-content:space-around}
button {background:#2a2f44;border:none;color:#fff;padding:10px;border-radius:8px;cursor:pointer;flex:1;margin:0 4px;font-size:14px}
button:hover {background:#3a3f5c}
input[type=file], input[type=number], input[type=text]{background:#2a2f44;color:#fff;border:none;padding:6px;border-radius:6px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.hint{color:#9aa0ae;font-size:12px}
</style>
</head>
<body>
<header>🎬 Jhim-montage-video</header>

<div class="viewer">
  <video id="video" controls></video>
  <canvas id="canvas" style="position:absolute;top:0;left:0;"></canvas>
</div>

<div class="controls">
  <label>📂 استيراد فيديو:
    <input type="file" id="fileInput" accept="video/*">
  </label>

  <div class="row">
    ⏱️ البداية (ث): <input type="number" id="startTime" value="0" min="0" step="0.1">
    ⏱️ النهاية (ث): <input type="number" id="endTime" value="5" min="0.1" step="0.1">
  </div>

  <div class="row">
    🔤 نص: <input type="text" id="textInput" placeholder="أكتب نص هنا">
  </div>

  <div class="toolbar">
    <button id="playBtn">▶️ تشغيل</button>
    <button id="pauseBtn">⏸️ إيقاف</button>
    <button id="cutBtn">✂️ قص مع النص</button>
  </div>
  <div class="hint">⚠️ النسخة Offline: لا تحتاج إنترنت لتشغيل ffmpeg</div>
</div>

<script src="ffmpeg.min.js"></script>
<script>
const { createFFmpeg, fetchFile } = FFmpeg;
const ffmpeg = createFFmpeg({ log: true });

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const fileInput = document.getElementById('fileInput');
const playBtn = document.getElementById('playBtn');
const pauseBtn = document.getElementById('pauseBtn');
const cutBtn = document.getElementById('cutBtn');
const textInput = document.getElementById('textInput');

let currentFile;
let animationFrame;

fileInput.addEventListener('change', async () => {
  currentFile = fileInput.files[0];
  if (currentFile) {
    const url = URL.createObjectURL(currentFile);
    video.src = url;
    video.play();
    drawOverlay();
  }
});

playBtn.addEventListener('click', ()=> { video.play(); drawOverlay(); });
pauseBtn.addEventListener('click', ()=> { video.pause(); cancelAnimationFrame(animationFrame); });

function drawOverlay() {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(video,0,0,canvas.width,canvas.height);
  ctx.font = "30px Arial";
  ctx.fillStyle = "yellow";
  ctx.fillText(textInput.value, 20, 50);
  animationFrame = requestAnimationFrame(drawOverlay);
}

cutBtn.addEventListener('click', async () => {
  if (!currentFile) return alert("📂 استورد فيديو أولاً");
  const start = parseFloat(document.getElementById('startTime').value || "0");
  const end = parseFloat(document.getElementById('endTime').value || "0");
  if (isNaN(start) || isNaN(end) || end <= start) return alert("⚠️ أوقات غير صالحة");

  if (!ffmpeg.isLoaded()) await ffmpeg.load();

  ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(currentFile));

  const text = textInput.value.replace(/:/g,'\\:');
  await ffmpeg.run(
    '-i','input.mp4',
    '-vf', `drawtext=text='${text}':fontcolor=yellow:fontsize=30:x=20:y=50`,
    '-ss', String(start),
    '-to', String(end),
    '-c:a','copy',
    'output.mp4'
  );

  const data = ffmpeg.FS('readFile','output.mp4');
  const url = URL.createObjectURL(new Blob([data.buffer], {type:'video/mp4'}));
  const a = document.createElement('a'); a.href = url; a.download='video-text.mp4'; a.click();
  alert('✅ تم قص الفيديو وإضافة النص وتنزيله');
});
</script>
</body>
</html>